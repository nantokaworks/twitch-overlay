version: "3"

tasks:
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
  build:frontend:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
    dir: web
    cmds:
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - bun run build
      - echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰å®Œäº† â†’ dist/public/"

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰
  build:backend:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
    dir: cmd/twitch-overlay
    vars:
      VERSION:
        sh: git describe --tags --always --dirty 2>/dev/null || echo "dev"
      COMMIT:
        sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
      BUILD_TIME:
        sh: date -u '+%Y-%m-%d %H:%M:%S UTC'
    cmds:
      - echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
      - |
        go build -ldflags "\
          -X 'github.com/nantokaworks/twitch-overlay/internal/version.Version={{.VERSION}}' \
          -X 'github.com/nantokaworks/twitch-overlay/internal/version.Commit={{.COMMIT}}' \
          -X 'github.com/nantokaworks/twitch-overlay/internal/version.BuildTime={{.BUILD_TIME}}'" \
          -o ../../dist/twitch-overlay .
      - echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰å®Œäº† â†’ dist/twitch-overlay"
      - |
        if [ "$(uname)" = "Linux" ]; then
          echo "ğŸ”§ Bluetoothæ¨©é™ã‚’è¨­å®šä¸­..."
          sudo setcap 'cap_net_raw,cap_net_admin+eip' ../../dist/twitch-overlay && \
            echo "âœ… æ¨©é™è¨­å®šå®Œäº†" || \
            echo "âš ï¸  æ¨©é™è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚sudoæ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          getcap ../../dist/twitch-overlay 2>/dev/null || true
        fi

  # çµ±åˆãƒ“ãƒ«ãƒ‰
  build:all:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä¸¡æ–¹ãƒ“ãƒ«ãƒ‰
    cmds:
      - task: clean
      - task: build:frontend
      - task: build:backend
      - echo "å…¨ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼"
      - echo "å®Ÿè¡Œ â†’ ./dist/twitch-overlay"

  # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  clean:
    desc: ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    cmds:
      - echo "ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
      - rm -rf dist
      - rm -rf web/dist
      - mkdir -p dist
      - echo "ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

  # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
  dev:frontend:
    desc: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
    dir: web
    cmds:
      - bun run dev

  # é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
  dev:backend:
    desc: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
    dir: cmd/twitch-overlay
    cmds:
      - air

  # Claude
  claude:
    desc: Claudeèµ·å‹•
    cmds:
      - claude --dangerously-skip-permissions

  # twitch-overlayãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
  stop:
    desc: å®Ÿè¡Œä¸­ã®twitch-overlayã‚’åœæ­¢
    cmds:
      - echo "twitch-overlayãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ä¸­..."
      - pkill -f twitch-overlay || echo "å®Ÿè¡Œä¸­ã®twitch-overlayãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"

  # Bluetoothæ¨©é™è¨­å®šï¼ˆLinuxã€æ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
  setcap:
    desc: Bluetoothç”¨ã®æ¨©é™ã‚’è¨­å®šï¼ˆLinuxã€æ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰
    cmds:
      - |
        if [ "$(uname)" != "Linux" ]; then
          echo "â„¹ï¸  ã“ã®ã‚¿ã‚¹ã‚¯ã¯Linuxç’°å¢ƒã§ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™"
          exit 0
        fi
      - |
        if [ ! -f dist/twitch-overlay ]; then
          echo "âŒ ã‚¨ãƒ©ãƒ¼: dist/twitch-overlay ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "å…ˆã« 'task build:all' ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
          exit 1
        fi
      - echo "ğŸ”§ Bluetoothæ¨©é™ã‚’è¨­å®šã—ã¾ã™ï¼ˆæ‰‹å‹•å®Ÿè¡Œç”¨ï¼‰..."
      - echo "â€» systemdã‚µãƒ¼ãƒ“ã‚¹ã§å®Ÿè¡Œã™ã‚‹å ´åˆã¯ä¸è¦ã§ã™"
      - sudo setcap cap_net_admin,cap_net_raw+eip dist/twitch-overlay
      - echo "âœ… æ¨©é™è¨­å®šå®Œäº†"
      - echo "ç¾åœ¨ã®æ¨©é™:"
      - getcap dist/twitch-overlay

  # ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
  run:
    desc: ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®twitch-overlayã‚’å®Ÿè¡Œ
    dir: dist
    cmds:
      - |
        if [ ! -f twitch-overlay ]; then
          echo "ã‚¨ãƒ©ãƒ¼: dist/twitch-overlay ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "å…ˆã« 'task build:all' ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã ã•ã„"
          exit 1
        fi
      - |
        if [ "$(uname)" = "Linux" ]; then
          # æ¨©é™ãƒã‚§ãƒƒã‚¯
          if ! getcap twitch-overlay 2>/dev/null | grep -q "cap_net_admin"; then
            echo "âš ï¸  è­¦å‘Š: Bluetoothæ¨©é™ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo ""
            echo "ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š"
            echo "  1. task setcap         ï¼ˆæ‰‹å‹•å®Ÿè¡Œç”¨ã®æ¨©é™è¨­å®šï¼‰"
            echo "  2. task service:install ï¼ˆsystemdã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè¡Œï¼‰"
            echo ""
            echo "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ [y/N]"
            read -r response
            if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
              exit 0
            fi
          fi
        fi
      - echo "twitch-overlayã‚’èµ·å‹•ä¸­..."
      - exec ./twitch-overlay

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    desc: å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    env:
      DRY_RUN_MODE: "true"
    cmds:
      - echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
      - go test ./...

  # é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆ
  package:
    desc: é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆ
    deps: [build:all]
    cmds:
      - echo "é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆä¸­..."
      - mkdir -p dist-package
      - cp -r dist/* dist-package/
      - cp .env.template dist-package/
      - |
        if [ -f .env ]; then
          cp .env dist-package/.env
          echo ".envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
        elif [ -f cmd/twitch-overlay/.env ]; then
          cp cmd/twitch-overlay/.env dist-package/.env
          echo "cmd/twitch-overlay/.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
        fi
      - echo "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº† â†’ dist-package/"

  # systemdã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  service:install:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLinuxï¼‰
    cmds:
      - |
        if [ ! -f scripts/install-service.sh ]; then
          echo "ã‚¨ãƒ©ãƒ¼: scripts/install-service.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
      - echo "systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
      - bash scripts/install-service.sh {{.CLI_ARGS}}

  # systemdã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  service:uninstall:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLinuxï¼‰
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - echo "systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
      - sudo systemctl stop twitch-overlay@{{.USERNAME}}.service || true
      - sudo systemctl disable twitch-overlay@{{.USERNAME}}.service || true
      - sudo rm -f /etc/systemd/system/twitch-overlay@{{.USERNAME}}.service
      - sudo systemctl daemon-reload
      - echo "ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

  # ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
  service:restart:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - echo "twitch-overlay@{{.USERNAME}}.service ã‚’å†èµ·å‹•ã—ã¾ã™..."
      - sudo systemctl restart twitch-overlay@{{.USERNAME}}.service
      - echo "å†èµ·å‹•å®Œäº†"
      - sudo systemctl status twitch-overlay@{{.USERNAME}}.service --no-pager

  # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
  service:start:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - echo "twitch-overlay@{{.USERNAME}}.service ã‚’èµ·å‹•ã—ã¾ã™..."
      - sudo systemctl start twitch-overlay@{{.USERNAME}}.service
      - echo "èµ·å‹•å®Œäº†"
      - sudo systemctl status twitch-overlay@{{.USERNAME}}.service --no-pager

  # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
  service:stop:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - echo "twitch-overlay@{{.USERNAME}}.service ã‚’åœæ­¢ã—ã¾ã™..."
      - sudo systemctl stop twitch-overlay@{{.USERNAME}}.service
      - echo "åœæ­¢å®Œäº†"

  # ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
  service:status:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - sudo systemctl status twitch-overlay@{{.USERNAME}}.service --no-pager

  # SSHãƒˆãƒ³ãƒãƒ«é–‹å§‹ï¼ˆheimdallï¼‰
  tunnel:heimdall:
    desc: heimdallã¸ã®SSHãƒˆãƒ³ãƒãƒ«ã‚’é–‹å§‹ï¼ˆãƒãƒ¼ãƒˆ3456ï¼‰
    cmds:
      - echo "heimdallã¸ã®SSHãƒˆãƒ³ãƒãƒ«ã‚’é–‹å§‹ã—ã¾ã™ (localhost:3456 -> heimdall:3456)"
      - ssh -L 3456:localhost:3456 heimdall -N &
      - echo "SSHãƒˆãƒ³ãƒãƒ«ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ"
      - echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3456 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"

  # SSHãƒˆãƒ³ãƒãƒ«åœæ­¢
  tunnel:stop:
    desc: SSHãƒˆãƒ³ãƒãƒ«ã‚’åœæ­¢
    cmds:
      - echo "SSHãƒˆãƒ³ãƒãƒ«ã‚’åœæ­¢ã—ã¾ã™..."
      - pkill -f "ssh.*3456.*heimdall" || true
      - echo "SSHãƒˆãƒ³ãƒãƒ«ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ"

  # ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚°ç¢ºèªï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
  service:logs:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - sudo journalctl -u twitch-overlay@{{.USERNAME}}.service -f

  # ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚°ç¢ºèªï¼ˆæœ€æ–°50è¡Œï¼‰
  service:logs:tail:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã®æœ€æ–°ãƒ­ã‚°ã‚’è¡¨ç¤º
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
      LINES:
        sh: echo ${2:-50}
    cmds:
      - sudo journalctl -u twitch-overlay@{{.USERNAME}}.service -n {{.LINES}} --no-pager

  # ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
  service:logs:error:
    desc: systemdã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿è¡¨ç¤º
    vars:
      USERNAME:
        sh: echo ${1:-$USER}
    cmds:
      - sudo journalctl -u twitch-overlay@{{.USERNAME}}.service -p err --no-pager
